"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = CachedHandler;
var _zlib = require("zlib");
var _cacheManager = require("./cache-manager");
var _metrics = require("./metrics");
var _payload = require("./payload");
var _renderer = _interopRequireDefault(require("./renderer"));
var _utils = require("./utils");
function _interopRequireDefault(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
function matchRules(conf, req) {
    var _method;
    const err = [
        'GET',
        'HEAD'
    ].indexOf((_method = req.method) != null ? _method : '') === -1;
    if (err) return {
        matched: false,
        ttl: -1
    };
    if (typeof conf.rules === 'function') {
        const ttl = conf.rules(req);
        if (ttl) return {
            matched: true,
            ttl
        };
    } else {
        var _rules;
        for (const rule of (_rules = conf.rules) != null ? _rules : []){
            if (req.url && new RegExp(rule.regex).test(req.url)) {
                return {
                    matched: true,
                    ttl: rule.ttl
                };
            }
        }
    }
    return {
        matched: false,
        ttl: 0
    };
}
/**
 * Wrap a http listener to serve cached response
 *
 * @param cache the cache
 * @param conf conf of next-boost
 * @param renderer the SSR renderer runs in worker thread
 * @param next pass-through handler
 *
 * @returns a request listener to use in http server
 */ const wrap = (cache, conf, renderer, next, metrics)=>{
    return async (req, res)=>{
        if (conf.metrics && (0, _metrics).forMetrics(req)) return (0, _metrics).serveMetrics(metrics, res);
        var _url;
        req.url = (0, _utils).filterUrl((_url = req.url) != null ? _url : '', conf.paramFilter);
        const key = conf.cacheKey ? conf.cacheKey(req) : req.url;
        const { matched , ttl  } = matchRules(conf, req);
        if (!matched) {
            metrics.inc('bypass');
            res.setHeader('x-next-boost-status', 'bypass');
            return next(req, res);
        }
        const lookupStart = new Date().getTime();
        const forced = req.headers['x-next-boost'] === 'update' // forced
        ;
        const state = await (0, _cacheManager).serveCache(cache, key, forced);
        res.setHeader('x-next-boost-status', state.status);
        metrics.inc(state.status);
        if (state.status === 'stale' || state.status === 'hit' || state.status === 'fulfill') {
            (0, _cacheManager).send(state.payload, res);
            if (!conf.quiet) {
                (0, _utils).log('info', 'URL served from cache', {
                    url: req.url,
                    cacheStatus: state.status,
                    cacheLookupMs: new Date().getTime() - lookupStart
                });
            }
            if (state.status !== 'stale') return; // stop here
        }
        try {
            const renderStart = new Date().getTime();
            await (0, _cacheManager).lock(key, cache);
            const args = {
                path: req.url,
                headers: req.headers,
                method: req.method
            };
            const rv = await renderer.render(args);
            if (ttl && rv.statusCode === 200 && conf.cacheControl) {
                rv.headers['cache-control'] = conf.cacheControl(req, ttl);
            }
            // rv.body is a Buffer in JSON format: { type: 'Buffer', data: [...] }
            const body = Buffer.from(rv.body);
            // stale has been served
            if (state.status !== 'stale') (0, _utils).serve(res, rv);
            if (!conf.quiet) {
                (0, _utils).log(rv.statusCode < 400 ? 'info' : 'warn', 'URL rendered', {
                    url: req.url,
                    cacheStatus: state.status,
                    cacheLookupMs: new Date().getTime() - lookupStart,
                    renderStatus: rv.statusCode,
                    renderMs: new Date().getTime() - renderStart
                });
            }
            if (rv.statusCode === 200) {
                // save gzipped data
                const payload = {
                    headers: rv.headers,
                    body: (0, _utils).isZipped(rv.headers) ? body : (0, _zlib).gzipSync(body)
                };
                await cache.set('payload:' + key, (0, _payload).encodePayload(payload), ttl);
            }
        } catch (e) {
            const error = e;
            (0, _utils).log('error', 'Render error', {
                key,
                errorMessage: error.message,
                errorStack: error.stack
            });
        } finally{
            await (0, _cacheManager).unlock(key, cache);
        }
    };
};
async function CachedHandler(args, options) {
    (0, _utils).log('info', 'Preparing cache adapter');
    // merge config
    const conf = (0, _utils).mergeConfig(options);
    // the cache
    if (!conf.cacheAdapter) {
        const { Adapter  } = require('@next-boost/hybrid-disk-cache');
        conf.cacheAdapter = new Adapter();
    }
    const adapter = conf.cacheAdapter;
    const cache = await adapter.init();
    const renderer = (0, _renderer).default();
    await renderer.init(args);
    const plain = await require(args.script).default(args);
    const metrics = new _metrics.Metrics();
    // init the child process for revalidate and cache purge
    return {
        handler: wrap(cache, conf, renderer, plain, metrics),
        cache,
        close: async ()=>{
            renderer.kill();
            await adapter.shutdown();
        }
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9oYW5kbGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY29taW5nTWVzc2FnZSB9IGZyb20gJ2h0dHAnXG5pbXBvcnQgeyBnemlwU3luYyB9IGZyb20gJ3psaWInXG5cbmltcG9ydCB7IGxvY2ssIHNlbmQsIHNlcnZlQ2FjaGUsIHVubG9jayB9IGZyb20gJy4vY2FjaGUtbWFuYWdlcidcbmltcG9ydCB7IGZvck1ldHJpY3MsIE1ldHJpY3MsIHNlcnZlTWV0cmljcyB9IGZyb20gJy4vbWV0cmljcydcbmltcG9ydCB7IGVuY29kZVBheWxvYWQgfSBmcm9tICcuL3BheWxvYWQnXG5pbXBvcnQgUmVuZGVyZXIsIHsgSW5pdEFyZ3MgfSBmcm9tICcuL3JlbmRlcmVyJ1xuaW1wb3J0IHsgQ2FjaGVBZGFwdGVyLCBIYW5kbGVyQ29uZmlnLCBXcmFwcGVkSGFuZGxlciB9IGZyb20gJy4vdHlwZXMnXG5pbXBvcnQgeyBmaWx0ZXJVcmwsIGlzWmlwcGVkLCBsb2csIG1lcmdlQ29uZmlnLCBzZXJ2ZSB9IGZyb20gJy4vdXRpbHMnXG5cbmZ1bmN0aW9uIG1hdGNoUnVsZXMoY29uZjogSGFuZGxlckNvbmZpZywgcmVxOiBJbmNvbWluZ01lc3NhZ2UpIHtcbiAgY29uc3QgZXJyID0gWydHRVQnLCAnSEVBRCddLmluZGV4T2YocmVxLm1ldGhvZCA/PyAnJykgPT09IC0xXG4gIGlmIChlcnIpIHJldHVybiB7IG1hdGNoZWQ6IGZhbHNlLCB0dGw6IC0xIH1cblxuICBpZiAodHlwZW9mIGNvbmYucnVsZXMgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCB0dGwgPSBjb25mLnJ1bGVzKHJlcSlcbiAgICBpZiAodHRsKSByZXR1cm4geyBtYXRjaGVkOiB0cnVlLCB0dGwgfVxuICB9IGVsc2Uge1xuICAgIGZvciAoY29uc3QgcnVsZSBvZiBjb25mLnJ1bGVzID8/IFtdKSB7XG4gICAgICBpZiAocmVxLnVybCAmJiBuZXcgUmVnRXhwKHJ1bGUucmVnZXgpLnRlc3QocmVxLnVybCkpIHtcbiAgICAgICAgcmV0dXJuIHsgbWF0Y2hlZDogdHJ1ZSwgdHRsOiBydWxlLnR0bCB9XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiB7IG1hdGNoZWQ6IGZhbHNlLCB0dGw6IDAgfVxufVxuXG4vKipcbiAqIFdyYXAgYSBodHRwIGxpc3RlbmVyIHRvIHNlcnZlIGNhY2hlZCByZXNwb25zZVxuICpcbiAqIEBwYXJhbSBjYWNoZSB0aGUgY2FjaGVcbiAqIEBwYXJhbSBjb25mIGNvbmYgb2YgbmV4dC1ib29zdFxuICogQHBhcmFtIHJlbmRlcmVyIHRoZSBTU1IgcmVuZGVyZXIgcnVucyBpbiB3b3JrZXIgdGhyZWFkXG4gKiBAcGFyYW0gbmV4dCBwYXNzLXRocm91Z2ggaGFuZGxlclxuICpcbiAqIEByZXR1cm5zIGEgcmVxdWVzdCBsaXN0ZW5lciB0byB1c2UgaW4gaHR0cCBzZXJ2ZXJcbiAqL1xuY29uc3Qgd3JhcDogV3JhcHBlZEhhbmRsZXIgPSAoY2FjaGUsIGNvbmYsIHJlbmRlcmVyLCBuZXh0LCBtZXRyaWNzKSA9PiB7XG4gIHJldHVybiBhc3luYyAocmVxLCByZXMpID0+IHtcbiAgICBpZiAoY29uZi5tZXRyaWNzICYmIGZvck1ldHJpY3MocmVxKSkgcmV0dXJuIHNlcnZlTWV0cmljcyhtZXRyaWNzLCByZXMpXG5cbiAgICByZXEudXJsID0gZmlsdGVyVXJsKHJlcS51cmwgPz8gJycsIGNvbmYucGFyYW1GaWx0ZXIpXG4gICAgY29uc3Qga2V5ID0gY29uZi5jYWNoZUtleSA/IGNvbmYuY2FjaGVLZXkocmVxKSA6IHJlcS51cmxcbiAgICBjb25zdCB7IG1hdGNoZWQsIHR0bCB9ID0gbWF0Y2hSdWxlcyhjb25mLCByZXEpXG4gICAgaWYgKCFtYXRjaGVkKSB7XG4gICAgICBtZXRyaWNzLmluYygnYnlwYXNzJylcbiAgICAgIHJlcy5zZXRIZWFkZXIoJ3gtbmV4dC1ib29zdC1zdGF0dXMnLCAnYnlwYXNzJylcbiAgICAgIHJldHVybiBuZXh0KHJlcSwgcmVzKVxuICAgIH1cblxuICAgIGNvbnN0IGxvb2t1cFN0YXJ0ID0gbmV3IERhdGUoKS5nZXRUaW1lKClcbiAgICBjb25zdCBmb3JjZWQgPSByZXEuaGVhZGVyc1sneC1uZXh0LWJvb3N0J10gPT09ICd1cGRhdGUnIC8vIGZvcmNlZFxuXG4gICAgY29uc3Qgc3RhdGUgPSBhd2FpdCBzZXJ2ZUNhY2hlKGNhY2hlLCBrZXksIGZvcmNlZClcbiAgICByZXMuc2V0SGVhZGVyKCd4LW5leHQtYm9vc3Qtc3RhdHVzJywgc3RhdGUuc3RhdHVzKVxuICAgIG1ldHJpY3MuaW5jKHN0YXRlLnN0YXR1cylcblxuICAgIGlmIChzdGF0ZS5zdGF0dXMgPT09ICdzdGFsZScgfHwgc3RhdGUuc3RhdHVzID09PSAnaGl0JyB8fCBzdGF0ZS5zdGF0dXMgPT09ICdmdWxmaWxsJykge1xuICAgICAgc2VuZChzdGF0ZS5wYXlsb2FkLCByZXMpXG5cbiAgICAgIGlmICghY29uZi5xdWlldCkge1xuICAgICAgICBsb2coJ2luZm8nLCAnVVJMIHNlcnZlZCBmcm9tIGNhY2hlJywge1xuICAgICAgICAgIHVybDogcmVxLnVybCxcbiAgICAgICAgICBjYWNoZVN0YXR1czogc3RhdGUuc3RhdHVzLFxuICAgICAgICAgIGNhY2hlTG9va3VwTXM6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gbG9va3VwU3RhcnQsXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIGlmIChzdGF0ZS5zdGF0dXMgIT09ICdzdGFsZScpIHJldHVybiAvLyBzdG9wIGhlcmVcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVuZGVyU3RhcnQgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgICAgYXdhaXQgbG9jayhrZXksIGNhY2hlKVxuXG4gICAgICBjb25zdCBhcmdzID0geyBwYXRoOiByZXEudXJsLCBoZWFkZXJzOiByZXEuaGVhZGVycywgbWV0aG9kOiByZXEubWV0aG9kIH1cbiAgICAgIGNvbnN0IHJ2ID0gYXdhaXQgcmVuZGVyZXIucmVuZGVyKGFyZ3MpXG4gICAgICBpZiAodHRsICYmIHJ2LnN0YXR1c0NvZGUgPT09IDIwMCAmJiBjb25mLmNhY2hlQ29udHJvbCkge1xuICAgICAgICBydi5oZWFkZXJzWydjYWNoZS1jb250cm9sJ10gPSBjb25mLmNhY2hlQ29udHJvbChyZXEsIHR0bClcbiAgICAgIH1cbiAgICAgIC8vIHJ2LmJvZHkgaXMgYSBCdWZmZXIgaW4gSlNPTiBmb3JtYXQ6IHsgdHlwZTogJ0J1ZmZlcicsIGRhdGE6IFsuLi5dIH1cbiAgICAgIGNvbnN0IGJvZHkgPSBCdWZmZXIuZnJvbShydi5ib2R5KVxuICAgICAgLy8gc3RhbGUgaGFzIGJlZW4gc2VydmVkXG4gICAgICBpZiAoc3RhdGUuc3RhdHVzICE9PSAnc3RhbGUnKSBzZXJ2ZShyZXMsIHJ2KVxuXG4gICAgICBpZiAoIWNvbmYucXVpZXQpIHtcbiAgICAgICAgbG9nKHJ2LnN0YXR1c0NvZGUgPCA0MDAgPyAnaW5mbycgOiAnd2FybicsICdVUkwgcmVuZGVyZWQnLCB7XG4gICAgICAgICAgdXJsOiByZXEudXJsLFxuICAgICAgICAgIGNhY2hlU3RhdHVzOiBzdGF0ZS5zdGF0dXMsXG4gICAgICAgICAgY2FjaGVMb29rdXBNczogbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBsb29rdXBTdGFydCxcbiAgICAgICAgICByZW5kZXJTdGF0dXM6IHJ2LnN0YXR1c0NvZGUsXG4gICAgICAgICAgcmVuZGVyTXM6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gcmVuZGVyU3RhcnQsXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIGlmIChydi5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgICAgLy8gc2F2ZSBnemlwcGVkIGRhdGFcbiAgICAgICAgY29uc3QgcGF5bG9hZCA9IHsgaGVhZGVyczogcnYuaGVhZGVycywgYm9keTogaXNaaXBwZWQocnYuaGVhZGVycykgPyBib2R5IDogZ3ppcFN5bmMoYm9keSkgfVxuICAgICAgICBhd2FpdCBjYWNoZS5zZXQoJ3BheWxvYWQ6JyArIGtleSwgZW5jb2RlUGF5bG9hZChwYXlsb2FkKSwgdHRsKVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IGVycm9yID0gZSBhcyBFcnJvclxuICAgICAgbG9nKCdlcnJvcicsICdSZW5kZXIgZXJyb3InLCB7XG4gICAgICAgIGtleSxcbiAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICBlcnJvclN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgIH0pXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IHVubG9jayhrZXksIGNhY2hlKVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBDYWNoZWRIYW5kbGVyKGFyZ3M6IEluaXRBcmdzLCBvcHRpb25zPzogSGFuZGxlckNvbmZpZykge1xuICBsb2coJ2luZm8nLCAnUHJlcGFyaW5nIGNhY2hlIGFkYXB0ZXInKVxuXG4gIC8vIG1lcmdlIGNvbmZpZ1xuICBjb25zdCBjb25mID0gbWVyZ2VDb25maWcob3B0aW9ucylcblxuICAvLyB0aGUgY2FjaGVcbiAgaWYgKCFjb25mLmNhY2hlQWRhcHRlcikge1xuICAgIGNvbnN0IHsgQWRhcHRlciB9ID0gcmVxdWlyZSgnQG5leHQtYm9vc3QvaHlicmlkLWRpc2stY2FjaGUnKVxuICAgIGNvbmYuY2FjaGVBZGFwdGVyID0gbmV3IEFkYXB0ZXIoKSBhcyBDYWNoZUFkYXB0ZXJcbiAgfVxuICBjb25zdCBhZGFwdGVyID0gY29uZi5jYWNoZUFkYXB0ZXJcbiAgY29uc3QgY2FjaGUgPSBhd2FpdCBhZGFwdGVyLmluaXQoKVxuXG4gIGNvbnN0IHJlbmRlcmVyID0gUmVuZGVyZXIoKVxuICBhd2FpdCByZW5kZXJlci5pbml0KGFyZ3MpXG4gIGNvbnN0IHBsYWluID0gYXdhaXQgcmVxdWlyZShhcmdzLnNjcmlwdCkuZGVmYXVsdChhcmdzKVxuXG4gIGNvbnN0IG1ldHJpY3MgPSBuZXcgTWV0cmljcygpXG5cbiAgLy8gaW5pdCB0aGUgY2hpbGQgcHJvY2VzcyBmb3IgcmV2YWxpZGF0ZSBhbmQgY2FjaGUgcHVyZ2VcbiAgcmV0dXJuIHtcbiAgICBoYW5kbGVyOiB3cmFwKGNhY2hlLCBjb25mLCByZW5kZXJlciwgcGxhaW4sIG1ldHJpY3MpLFxuICAgIGNhY2hlLFxuICAgIGNsb3NlOiBhc3luYyAoKSA9PiB7XG4gICAgICByZW5kZXJlci5raWxsKClcbiAgICAgIGF3YWl0IGFkYXB0ZXIuc2h1dGRvd24oKVxuICAgIH0sXG4gIH1cbn1cbiJdLCJuYW1lcyI6WyJDYWNoZWRIYW5kbGVyIiwibWF0Y2hSdWxlcyIsImNvbmYiLCJyZXEiLCJlcnIiLCJpbmRleE9mIiwibWV0aG9kIiwibWF0Y2hlZCIsInR0bCIsInJ1bGVzIiwicnVsZSIsInVybCIsIlJlZ0V4cCIsInJlZ2V4IiwidGVzdCIsIndyYXAiLCJjYWNoZSIsInJlbmRlcmVyIiwibmV4dCIsIm1ldHJpY3MiLCJyZXMiLCJwYXJhbUZpbHRlciIsImtleSIsImNhY2hlS2V5IiwiaW5jIiwic2V0SGVhZGVyIiwibG9va3VwU3RhcnQiLCJEYXRlIiwiZ2V0VGltZSIsImZvcmNlZCIsImhlYWRlcnMiLCJzdGF0ZSIsInN0YXR1cyIsInBheWxvYWQiLCJxdWlldCIsImNhY2hlU3RhdHVzIiwiY2FjaGVMb29rdXBNcyIsInJlbmRlclN0YXJ0IiwiYXJncyIsInBhdGgiLCJydiIsInJlbmRlciIsInN0YXR1c0NvZGUiLCJjYWNoZUNvbnRyb2wiLCJib2R5IiwiQnVmZmVyIiwiZnJvbSIsInJlbmRlclN0YXR1cyIsInJlbmRlck1zIiwic2V0IiwiZSIsImVycm9yIiwiZXJyb3JNZXNzYWdlIiwibWVzc2FnZSIsImVycm9yU3RhY2siLCJzdGFjayIsIm9wdGlvbnMiLCJjYWNoZUFkYXB0ZXIiLCJBZGFwdGVyIiwicmVxdWlyZSIsImFkYXB0ZXIiLCJpbml0IiwicGxhaW4iLCJzY3JpcHQiLCJkZWZhdWx0IiwiaGFuZGxlciIsImNsb3NlIiwia2lsbCIsInNodXRkb3duIl0sIm1hcHBpbmdzIjoi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